# ComfoControl Protocol
This document tries to explain the ComfoControl Protocol used by Zehnder ventilation units. You need a
*ComfoConnect LAN C* device to interface with the unit.

**Warning: This documentation is incomplete. If you have more information, don't hesitate to contribute by opening an
issue or making a PR.**

## General packet structure
The messages are send in a TCP-connection to port 56747, and are prepended with a header that resembles the
"Lenght-prefix protocol buffers" format.

This file [zehnder.proto](protobuf/zehnder.proto) contains a structured description of the protocol.

## Manually decoding a packet
The `protoc` utility can be used to manually decode a message based on the hex representation of the payload. You need
to strip the headers and extract the `cmd` and `msg` before passing it to `protoc`. See the sections below to find out
what to strip.

Example:
```markdown
0000004 ea886190220044d68a07d85a2e3866fce 0000000000251010800170b3d54264b4 0004 08022002 0a10a886190220044d68a07d85a2e3866fce10001a126950686f6e652076616e2044657374696e79
length_ src______________________________ dst_____________________________ cmd# cmd_____ msg_____________________________________________________________________________
```

Command:
```sh
$ echo "08022002" | xxd -r -p | protoc --decode=GatewayOperation zehnder.proto
```
```javascript
type: RegisterAppRequestType
reference: 2
```

Message:
```sh
$ echo "0a10a886190220044d68a07d85a2e3866fce10001a126950686f6e652076616e2044657374696e79" | xxd -r -p | protoc --decode=RegisterAppRequest zehnder.proto
```
```javascript
uuid: "\250\206\031\002 \004Mh\240}\205\242\343\206o\316"
pin: 0
devicename: "iPhone van Destiny"
```

## Device discovery (`DiscoveryOperation`)
The bridge can be discovered by sending an UDP packet containing `0x0a00` to your network's broadcast address on port
56747. It will respond with the following connection information, also in a UDP packet. The last 6 bytes of the
identifier seems to be the bridge's MAC address. This packet contains no header and can be fully passed to Protocol
Buffers.

Raw response data:
```
12230a0d3139322e3136382e312e32313312100000000000251010800170b3d54264b41801
```
```javascript
searchGatewayResponse {
  ipaddress: "192.168.1.213"
  uuid: "\000\000\000\000\000%\020\020\200\001p\263\325Bd\264"
  version: 1
}
```

You now have the bridge's `ipaddress` and `uuid`. You need these for further communication.

## Bridge communication (`GatewayOperation`)
Further communication with the bridge happens by opening a TCP connection to the bridge on port 56747. Every message
will start with the `length` of the message, excluding this `length`-field itself. 

Note that only `op` and `msg` is valid Protocol Buffers data. The other fields should not be parsed.

### Header
The header then consist of a `src`, `dst` and `op_length`, followed by the `op` and the `msg`. The `src` seems to be
generated by the client, the `dst` has to be obtained from the discovery packet (`uuid`). The `op_length` fields
indicates the length of the `op` field, the rest of the data contains the `msg`.

| Field                 | Data                                 | Remark                                                |
|-----------------------|--------------------------------------|-------------------------------------------------------|
| length (32 bit)       | `0x0000004f`                         | Length of the whole message excluding this field      |
| src (12 bytes)        | `0xaf154804169043898d2da77148f886be` |                                                       |
| dst (12 bytes)        | `0x0000000000251010800170b3d54264b4` |                                                       |
| oplength (16 bit)     | `0x0004`                             | Length of the `op` message                            | 
| op (variable length)  | `0x08342002`                         | Message with type `GatewayOperation`                  |
| msg (variable length) | `...`                                | Message with type that is stated in `op.type`         |

### Commands
A message consists of a command block (`GatewayOperation`) and a message block (variable type). The command block
contains a `type` and `reference` field. The `type` field indicates the type of the message block. The `reference` field
will contain a incremental number that can be used to link a request with a reply.

This is a list of the commands.

| Request                       | Confirm                       | Notification / Response | Description                |
|-------------------------------|-------------------------------|-------------------------|----------------------------|
| NoOperation                   |                               |                         |                            |
| SetAddressRequestType         | SetAddressConfirmType         |                         |                            |
| RegisterAppRequestType        | RegisterAppConfirmType        |                         | Adds a device in the registration list |
| StartSessionRequestType       | StartSessionConfirmType       |                         | Start as session with the bridge |
| CloseSessionRequestType       | CloseSessionConfirmType       |                         | Terminate your session     |
| ListRegisteredAppsRequestType | ListRegisteredAppsConfirmType |                         | Returns a list of registered apps on the bridge |
| DeregisterAppRequestType      | DeregisterAppConfirmType      |                         | Remove a UUID from the registration list |
| ChangePinRequestType          | ChangePinConfirmType          |                         | Change the PIN code        |
| GetRemoteAccessIdRequestType  | GetRemoteAccessIdConfirmType  |                         |                            |
| SetRemoteAccessIdRequestType  | SetRemoteAccessIdConfirmType  |                         |                            |
| GetSupportIdRequestType       | GetSupportIdConfirmType       |                         |                            |
| GetWebIdRequestType           | GetWebIdConfirmType           |                         |                            |
| SetWebIdRequestType           | SetWebIdConfirmType           |                         |                            |
| SetPushIdRequestType          | SetPushIdConfirmType          |                         |                            |
| DebugRequestType              | DebugConfirmType              |                         |                            |
| UpgradeRequestType            | UpgradeConfirmType            |                         |                            |
| SetDeviceSettingsRequestType  | SetDeviceSettingsConfirmType  |                         |                            |
| VersionRequestType            | VersionConfirmType            |                         |                            |
|                               |                               | GatewayNotificationType |                            |
|                               |                               | KeepAliveType           |                            |
| FactoryResetType              |                               |                         |                            |
| CnTimeRequestType             | CnTimeConfirmType             |                         |                            |
| CnNodeRequestType             |                               | CnNodeNotificationType  |                            |
| CnRmiRequestType              | CnRmiResponseType             |                         |                            |
| CnRmiAsyncRequestType         | CnRmiAsyncConfirmType         | CnRmiAsyncResponseType  |                            |
| CnRpdoRequestType             | CnRpdoConfirmType             | CnRpdoNotificationType  |                            |
|                               |                               | CnAlarmNotificationType |                            |
| CnFupReadRegisterRequestType  | CnFupReadRegisterConfirmType  |                         |                            |
| CnFupProgramBeginRequestType  | CnFupProgramBeginConfirmType  |                         |                            |
| CnFupProgramRequestType       | CnFupProgramConfirmType       |                         |                            |
| CnFupProgramEndRequestType    | CnFupProgramEndConfirmType    |                         |                            |
| CnFupReadRequestType          | CnFupReadConfirmType          |                         |                            |
| CnFupResetRequestType         | CnFupResetConfirmType         |                         |                            |

#### RegisterApp (`RegisterAppRequestType` and `RegisterAppConfirmType`)
Before you can login, you need to register your device, by sending a `type: RegisterAppRequestType`.
```javascript
type: RegisterAppRequestType
reference: 15

uuid: "\251\226\031\002 \004Mh\240}\205\242\343\206o\312"
pin: 0
devicename: "Computer"
```

The bridge will respond with a `type: RegisterAppConfirmType`. 
In case of success, it will respond like this:
```javascript
type: RegisterAppConfirmType
reference: 15
```

In case of a failure (invalid PIN), it will respond with a `result: NOT_ALLOWED`.
```javascript
type: RegisterAppConfirmType
result: NOT_ALLOWED
reference: 15
```

#### StartSession (`StartSessionRequestType` and `StartSessionConfirmType`)
The client logs in by sending a `type: StartSessionRequestType`. Only one client can be logged in at the same time.
```javascript
type: StartSessionRequestType
reference: 16
```

In case of a success, it will respond with a `type: StartSessionRequestType` with `result: OK`.
```javascript
type: StartSessionConfirmType
result: OK
reference: 16
```

If another client is already logged in, the bridge will respond with a `result` of `OTHER_SESSION`. The name of the
other device will be in `devicename`.  
```javascript
type: StartSessionConfirmType
result: OTHER_SESSION
reference: 16

devicename: "Google Nexus 5X"
```

You can force the takeover of this session by specifying a `takeover: 1`.
```javascript
type: StartSessionConfirmType
result: OK
reference: 17

takeover: 1
```

Next, we see a few notifications. They seem to be messages to let the client know what nodes are available. We only
send messages to `nodeId: 1`.
```javascript
type: CnNodeNotificationType

nodeId: 1
productId: 1
zoneId: 1
mode: NODE_NORMAL
```

```javascript
type: CnNodeNotificationType

nodeId: 48
productId: 5
zoneId: 255
mode: NODE_NORMAL
```

#### CloseSession (`CloseSessionRequestType`)
The client logs out by sending a `type: CloseSessionRequestType`. The bridge doesn't seem to send a response on 
this.
```javascript
type: CloseSessionRequestType
```

When the session is closed by the bridge (because another client connects with `takeover: 1`), the bridge will also send
a `type: CloseSessionRequestType` message to the client.

#### CnRpdoRequest (`CnRpdoRequestType`, `CnRpdoConfirmType` and `CnRpdoNotificationType`)
To receive status updates, you need to register to a `pdid` by sending a `type: CnRpdoRequestType`. You also need
to specify a `pdid`, `zone`, `type` and `timeout`. The zone always seems to be `1`. The `type` seems to depend on the 
`pdid`.
```javascript
type: CnRpdoRequestType
reference: 104

pdid: 176
zone: 1
type: 1
timeout: 4294967295
```

The bridge will reply with a `type: CnRpdoConfirmType`.
```javascript
type: CnRpdoConfirmType
result: OK
reference: 104
```

Next, when an update is available, the bridge will send a `type: CnRpdoNotificationType`.
```javascript
type: CnRpdoNotificationType

pdid: 176
data: "\000"
```

Overview of known pdids:

| pdid | type | description                                                                                            |
|------|------|--------------------------------------------------------------------------------------------------------|
| 65   | 1    | Fans: Fan speed setting (`00` (away), `01`, `02` or `03`) |
| 117  | 1    | Fans: Supply fan duty (`1c` = 28%) |
| 118  | 1    | Fans: Exhaust fan duty (`1d` = 29%) |
| 119  | 2    | Fans: Supply fan flow (`6e00` = 110 m³/h) |
| 120  | 2    | Fans: Exhaust fan flow (`6900` = 105 m³/h) |
| 121  | 2    | Fans: Supply fan speed (`2d04` = 1069 rpm) |
| 122  | 2    | Fans: Exhaust fan speed (`5904` = 1113 rpm) |
| 128  | 2    | Power Consumption: Current Ventilation (`0f00` = 15 W)  |
| 129  | 2    | Power Consumption: Total year-to-date (`1700` = 23 kWh) |
| 130  | 2    | Power Consumption: Total from start (`1700` = 23 kWh) |
| 192  | 2    | Days left before filters must be replaced (`8200` = 130 days) |
| 213  | 2    | Avoided Heating: Avoided actual: (`b901` = 441 -> 4.41 W) |
| 214  | 2    | Avoided Heating: Avoided year-to-date: (`dd01` = 477 kWh) |
| 215  | 2    | Avoided Heating: Avoided total: (`dd01` = 477 kWh) |
| 221  | 6    | Temperature & Humidity: Supply Air (`aa00` = 170 -> 17.0 °C) |
| 274  | 6    | Temperature & Humidity: Extract Air (`ab00` = 171 -> 17.1 °C) |
| 275  | 6    | Temperature & Humidity: Exhaust Air (`5600` = 86 -> 8.6 °C) |
| 276  | 6    | Temperature & Humidity: Outdoor Air (`3c00` = 60 -> 6.0 °C) |
| 290  | 1    | Temperature & Humidity: Extract Air (`31` = 49%) |
| 291  | 1    | Temperature & Humidity: Exhaust Air (`57` = 87%) |
| 292  | 1    | Temperature & Humidity: Outdoor Air (`43` = 67%) |
| 294  | 1    | Temperature & Humidity: Supply Air (`23` = 35%) |
| 16   | 1    | *Unknown* (`01`) |
| 33   | 1    | *Unknown* (`01`) |
| 37   | 1    | *Unknown* (`00`) |
| 49   | 1    | *Unknown* (`01`) |
| 53   | 1    | *Unknown* (`ff`) |
| 56   | 1    | *Unknown* (`01`) |
| 66   | 1    | *Unknown* (`00`) |
| 67   | 1    | *Unknown* (`00`) |
| 70   | 1    | *Unknown* (`00`) |
| 71   | 1    | *Unknown* (`00`) |
| 81   | 3    | *Unknown* (`ffffffff`) |
| 82   | 3    | *Unknown* (`ffffffff`) |
| 85   | 3    | *Unknown* (`ffffffff`) |
| 86   | 3    | *Unknown* (`ffffffff`) |
| 87   | 3    | *Unknown* (`ffffffff`) |
| 144  | 2    | *Unknown* (`00`) |
| 145  | 2    | *Unknown* (`00`) |
| 146  | 2    | *Unknown* (`00`) |
| 176  | 1    | *Unknown* (`00`) |
| 208  | 1    | *Unknown* (`00`) |
| 209  | 6    | *Unknown* (`4700` = 71 ) |
| 210  | 0    | *Unknown* (`00`) |
| 211  | 0    | *Unknown* (`00`) |
| 212  | 6    | *Unknown* (`ee00` = 238) |
| 216  | 2    | *Unknown* (`0000`) |
| 217  | 2    | *Unknown* (`0000`) |
| 218  | 2    | *Unknown* (`0000`) |
| 219  | 2    | *Unknown* (`0000`) |
| 224  | 1    | *Unknown* (`03` = 3) |
| 225  | 1    | *Unknown* (`01`) |
| 226  | 2    | *Unknown* (`6400` = 100) |
| 227  | 1    | *Unknown* (`05`) |
| 228  | 1    | *Unknown* (`00`) |
| 321  | 2    | *Unknown* (`0700` = 7) |
| 325  | 2    | *Unknown* (`0100` = 1) |
| 337  | 3    | *Unknown* (`26000000` = 2409368) |
| 338  | 3    | *Unknown* (`00000000`) |
| 341  | 3    | *Unknown* (`00000000`) |
| 369  | 1    | *Unknown* (`00`) |
| 370  | 1    | *Unknown* (`00`) |
| 371  | 1    | *Unknown* (`00`) |
| 372  | 1    | *Unknown* (`00`) |
| 384  | 6    | *Unknown* (`0000`) |
| 386  | 0    | *Unknown* (`00`) |
| 400  | 6    | *Unknown* (`0000`) |
| 401  | 1    | *Unknown* (`00`) |
| 402  | 0    | *Unknown* (`00`) |
| 416  | 6    | *Unknown* (`70fe` = -400) |
| 417  | 6    | *Unknown* (`6400` = 100) |
| 418  | 1    | *Unknown* (`00`) |
| 419  | 0    | *Unknown* (`00`) |

#### CnRmiRequest (`CnRmiRequestType` and `CnRmiResponseType`)
You can execute a function on the device by invoking a `type: CnRmiRequestType`. You need to specify the `nodeId` and a `message`.

```javascript
type: CnRmiRequestType
reference: 122

nodeId: 1
message: "\001\001\001\020\010"
```

The bridge will respond with a `type: CnRmiResponseType`.
```javascript
type: CnRmiResponseType
reference: 122

message: "ComfoAir Q450 B R RF ST Quality\000"
```

Overview of known CnRmiRequests:

| Request                | Response                                                   | Description                    |
|------------------------|------------------------------------------------------------|--------------------------------|
| `02010101150304060507` | `\x02BEA004185031910\x00\x00\x10\x10\xc0\x02\x00T\x10@`    | *Unknown*                      |
| `80150101`             | `\x01\x00\x00\x00\x80Q\x01\x00\xff\xff\xff\xff\x01`        | *Unknown*                      |
| `83150101`             | `\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x01` | *Unknown*                      |
| `83150102`             | `\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x03` | *Unknown*                      |
| `83150105`             | `\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x01` | *Unknown*                      |
| `871501`               | `\x0b\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x01\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x03\x00\x00\x00\x00\x00 \x1c\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00 \x1c\x00\x00\x00\x00\x00\x00\x01\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x01\x00\x00\x00\x00\x00X\x02\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00X\x02\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x08\x07\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x08\x07\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00X\x02\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\xb0\x04\x00\x00\x00\x00\x00\x00\x00` | *Unknown* |
| `871505`               | `\x01\x00\x00\x00\x00\x00\x08\x07\x00\x00\x00\x00\x00\x00\x01` | *Unknown*                  |
| `0117011002`           | `\x01`                                                     | *Unknown*                      |
| `0117021002`           | `\x00`                                                     | *Unknown*                      |
| `010101100b`           | `471502004\x00`                                            | *Unknown*                      |
| `012401100b`           | `\x00`                                                     | *Unknown*                      |
| `0125001003`           | `\x00`                                                     | *Unknown*                      |
| `0120011006`           | `\x00`                                                     | *Unknown*                      | 
| `861501`               | `\x01\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x02\x01\x00\x00\x00\x80Q\x01\x00\xff\xff\xff\xff\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00` | *Unknown* |
| `0120011006`           | `\x00`                                                     | *Unknown*                      |
| `0101011008`           | `ComfoAir Q450 B R RF ST Quality\x00`                      | HRU Type                       |
