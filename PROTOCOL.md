Zehnder ComfoConnect LAN C Protocol description
===============================================

**Warning: This documentation is very incomplete. If you have more information, don't hesitate to contribute by opening an issue or making a PR.**

# General remarks
* Variable length strings seems to be prepended with `0x0a..` where `..` is a 16 bit integer telling the length of the next string.
  Todo: need to find out why it's `0x1a..` sometimes.

# Discovery
The bridge can be discovered by sending a an UDP packet containing `0x0a00` to your network's broadcast address on port 56747.
It will respond with the following connection information. 
The last 6 bytes of the identifier are the bridge's MAC address.

| Field                     | Data                                 | Remark    |
|---------------------------|--------------------------------------|-----------|
| Length (32 bit)           | `0x12` `0x..`                        | The length of the whole packet, including this field |
| IP-Address                | `0x0a0c` `192.168.1.25`              | Length + The IP address of the bridge |
|                           | `0x1210`                             | _Unknown_ |
| Identifier (16 bytes)     | `0x0000000000251010800170b3d54264b4` | The identifier of the bridge |
|                           | `0x1801`                             | _Unknown_ |

# Communication
Further communication with the bridge happens trough a TCP connection to port 56747.
Every message will start with the `length` of the message, followed by a `src` and a `dst`. 
The `src` seems to be generated by the client, the `dst` has to be obtained from the discovery packet.

| Field                     | Data                                 | Remark    |
|---------------------------|--------------------------------------|-----------|
| Length (32 bit)           | `0x00000026`                         | The length of the whole packet (with data), including this field |
| Source (16 bytes)         | `0x0000000000251010800170b3d54264b4` | |
| Destination (16 bytes)    | `0xa886190220044d68a07d85a2e3866fce` | |

This header should be attached before every message.

## Registration
Before you can login, you need to register your device. 

If the PIN is 0000, the field should be 0x00, otherwise, it should be written as a 16 bit number encoded according to the following algorithm.
* Convert the number to binary
* Insert a 1 before the 7th digit starting from the end (101110111000 -> 1011110111000)
* Convert the number to hexadecimal
* Swap the bytes (0x0023 -> 0x2300)

| Field                     | Data                                 | Remark    |
|---------------------------|--------------------------------------|-----------|
| Command 1 (32 bit)        | `0x0004`                             | _Unknown_ |
| Command 2 (32 bit)        | `0x0802`                             | _Unknown_ |
| Sequence Number           | `0x2002`                             | |
|                           | `0x0a10`                             | _Unknown_ |
| Identifier (16 bytes)     | `0xa886190220044d68a07d85a2e3866fce` | The `src` identifier of the client |
|                           | `0x10`                               | |
|                           | `0x00` or `0x....`                   | PIN code, see note above |
|                           | `0x1a`                     `         | |
| Name                      | `0x11` `Phone van Michael`           | Length + A string containing the display name of your client |

In case of a failure (invalid PIN), the bridge will respond with the following message:
| Field                     | Data                                 | Remark    |
|---------------------------|--------------------------------------|-----------|
| Command 1 (32 bit)        | `0x0006`                             | _Unknown_ |
| Command 2 (32 bit)        | `0x0834`                             | _Unknown_ |
| Command 3 (32 bit)        | `0x1005`                             | _Unknown_ |
| Reply to sequence number  | `0x2002`                             | |


In case of success, the bridge will then respond with the following message:
| Field                     | Data                                 | Remark    |
|---------------------------|--------------------------------------|-----------|
| Command 1 (32 bit)        | `0x0004`                             | _Unknown_ |
| Command 2 (32 bit)        | `0x0834`                             | _Unknown_ |
| Reply to sequence number  | `0x2002`                             | |

# Login session

The client logs in by sending the following message:
| Field                     | Data                                 | Remark    |
|---------------------------|--------------------------------------|-----------|
| Command 1 (32 bit)        | `0x0004`                             | _Unknown_ |
| Command 2 (32 bit)        | `0x0803`                             | _Unknown_ |
| Sequence number (32 bit)  | `0x2003`                             |  |
|                           | `0x0801` (optional)                  | _Unknown_, this is added during the first login |

In case of success, the bridge will then respond with a series of messages:

First, it will ACK the login message
| Field                     | Data                                 | Remark    |
|---------------------------|--------------------------------------|-----------|
| Command 1 (32 bit)        | `0x0006`                             | _Unknown_ |
| Command 2 (32 bit)        | `0x0835`                             | _Unknown_ |
| Command 3 (32 bit)        | `0x1000`                             |  |
| Ack'ed sequence number    | `0x2003`                             | This references a send message |

Next, we see some other messages. I don't know what they mean.
| Field                     | Data                                 | Remark    |
|---------------------------|--------------------------------------|-----------|
| Command 1 (32 bit)        | `0x0002`                             | _Unknown_ |
| Command 2 (32 bit)        | `0x0820`                             | _Unknown_ |
| Command 3 (32 bit)        | `0x0801`                             | _Unknown_ |
|                           | `0x100118012002`                     | _Unknown_ |

| Field                     | Data                                 | Remark    |
|---------------------------|--------------------------------------|-----------|
| Command 1 (32 bit)        | `0x0002`                             | _Unknown_ |
| Command 2 (32 bit)        | `0x0820`                             | _Unknown_ |
| Command 3 (32 bit)        | `0x0830`                             | _Unknown_ |
|                           | `0x100518ff012002`                   | _Unknown_ |
