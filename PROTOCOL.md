# ComfoControl Protocol
This document tries to explain the ComfoControl Protocol used by Zehnder ventilation units. You need a *ComfoConnect LAN C* device to interface with the unit.

**Warning: This documentation is very incomplete. If you have more information, don't hesitate to contribute by opening an issue or making a PR.**

## General packet structure
The messages are send in a TCP-connection to port 56747, and are prepended with a header that resembles the "Lenght-prefix protocol buffers" format.

This file [zehnder.proto](zehnder.proto) contains a structured description of the protocol.

### Manually decoding a packet
The `protoc` utility can be used to manually decode a message based on the hex representation of the payload. You need to strip the headers before passing it to `protoc`. See the sections below to find out what to strip.

Example:
```markdown
0000004ea886190220044d68a07d85a2e3866fce0000000000251010800170b3d54264b40004 080220020a10a886190220044d68a07d85a2e3866fce10001a126950686f6e652076616e2044657374696e79
```

```sh
$ echo "080220020a10a886190220044d68a07d85a2e3866fce10001a126950686f6e652076616e2044657374696e79" | xxd -r -p | protoc --decode=GatewayOperation zehnder.proto
```
```javascript
type: RegisterAppRequestType
result: OK
resultDescription: "iPhone van Destiny"
reference: 2
1: "\250\206\031\002 \004Mh\240}\205\242\343\206o\316"
```

## Device discovery (`DiscoveryOperation`)
The bridge can be discovered by sending an UDP packet containing `0x0a00` to your network's broadcast address on port 56747.
It will respond with the following connection information, also in a UDP packet. The last 6 bytes of the identifier seems to be the bridge's MAC address. This packet contains no header and can be fully passed to Protocol Buffers.

Raw response data:
```
12230a0d3139322e3136382e312e32313312100000000000251010800170b3d54264b41801
```
```javascript
searchGatewayResponse {
  ipaddress: "192.168.1.213"
  uuid: "\000\000\000\000\000%\020\020\200\001p\263\325Bd\264"
  version: 1
}
```

You now have the bridge's `ipaddress` and `uuid`. You need these for further communication.

## Bridge communication (`GatewayOperation`)
Further communication with the bridge happens by opening a TCP connection to the bridge on port 56747.
Every message will start with the `length` of the message, followed by a `src` and a `dst`. 
The `src` seems to be generated by the client, the `dst` has to be obtained from the discovery packet (`uuid`).
This header is attached before every message. This has to be stripped off before feeding it to Protocol Buffers.

### Header
| Field          | Data                                         | Remark         |
|----------------|----------------------------------------------|----------------|
| Length         | `0x0000004f`                                 | Total length of the whole packet |
| Source         | `0xaf154804169043898d2da77148f886be`         |                |
| Destination    | `0x0000000000251010800170b3d54264b4`         |                |
| ???            | `0x0004`                                     | This field can be `0x002`, `0x004` or `0x006`. Seems to be related of the lenght of the following field. |
| Payload        | `...`                                        |                |

### Commands

This is a list of the commands. They are all encapsulated in a `GatewayOperation`. I've included the `???` field, since it might be part of the payload.

```javascript
  NoOperation = 0;

  # ...
  SetAddressRequestType = 1;
  SetAddressConfirmType = 51;

  # Register
  RegisterAppRequestType = 2;
  RegisterAppConfirmType = 52;

  # Login
  StartSessionRequestType = 3;
  StartSessionConfirmType = 53;

  # Logout
  CloseSessionRequestType = 4;
  CloseSessionConfirmType = 54;

  # Fetch a list of all registered apps
  ListRegisteredAppsRequestType = 5;
  ListRegisteredAppsConfirmType = 55;

  # Unregister a registered app
  DeregisterAppRequestType = 6;
  DeregisterAppConfirmType = 56;

  # Change the PIN code
  ChangePinRequestType = 7;
  ChangePinConfirmType = 57;

  # ...
  GetRemoteAccessIdRequestType = 8;
  GetRemoteAccessIdConfirmType = 58;

  # ...
  SetRemoteAccessIdRequestType = 9;
  SetRemoteAccessIdConfirmType = 59;

  # ...
  GetSupportIdRequestType = 10;
  GetSupportIdConfirmType = 60;

  # ...
  SetSupportIdRequestType = 11;
  SetSupportIdConfirmType = 61;

  # ...
  GetWebIdRequestType = 12;
  GetWebIdConfirmType = 62;

  # ...
  SetWebIdRequestType = 13;
  SetWebIdConfirmType = 63;

  # ...
  SetPushIdRequestType = 14;
  SetPushIdConfirmType = 64;

  # ...
  DebugRequestType = 15;
  DebugConfirmType = 65;

  # ...
  UpgradeRequestType = 16;
  UpgradeConfirmType = 66;

  # ...
  SetDeviceSettingsRequestType = 17;
  SetDeviceSettingsConfirmType = 67;

  # ...
  VersionRequestType = 18;
  VersionConfirmType = 68;

  # ...
  GatewayNotificationType = 100;

  # ...
  KeepAliveType = 101;

  # ...
  FactoryResetType = 102;

  # ...
  CnTimeRequestType = 30;
  CnTimeConfirmType = 31;

  # ...
  CnNodeRequestType = 42;
  CnNodeNotificationType = 32;

  # ...
  CnRmiRequestType = 33;
  CnRmiResponseType = 34;

  # ...
  CnRmiAsyncRequestType = 35;
  CnRmiAsyncConfirmType = 36;
  CnRmiAsyncResponseType = 37;

  # ...
  CnRpdoRequestType = 38;
  CnRpdoConfirmType = 39;
  CnRpdoNotificationType = 40;

  # ...
  CnAlarmNotificationType = 41;

  # ...
  CnFupReadRegisterRequestType = 70;
  CnFupReadRegisterConfirmType = 71;

  # ...
  CnFupProgramBeginRequestType = 72;
  CnFupProgramBeginConfirmType = 73;

  # ...
  CnFupProgramRequestType = 74;
  CnFupProgramConfirmType = 75;

  # ...
  CnFupProgramEndRequestType = 76;
  CnFupProgramEndConfirmType = 77;

  # ...
  CnFupReadRequestType = 78;
  CnFupReadConfirmType = 79;

  # ...
  CnFupResetRequestType = 80;
  CnFupResetConfirmType = 81;
```

### RegisterApp (`RegisterAppRequestType` and `RegisterAppConfirmType`)
Before you can login, you need to register your device, by sending `RegisterAppRequestType`.
```
0004 080220020a10a886190220044d68a07d85a2e3866fce10001a126950686f6e652076616e2044657374696e79
```
```javascript
type: RegisterAppRequestType
result: OK
resultDescription: "iPhone van Destiny"
reference: 2
1: "\250\206\031\002 \004Mh\240}\205\242\343\206o\316"
```

The bridge will respond with a `RegisterAppConfirmType`.

In case of success, it will respond like this:
```
0004 08342002
```
```javascript
type: RegisterAppConfirmType
reference: 2
```

In case of a failure (invalid PIN), it will respond with a GatewayResult `NOT_ALLOWED`.
```
TODO: message example
```

## StartSession
The client logs in by sending a `StartSessionRequestType`.
```
0004 0803203e
```
```javascript
type: StartSessionRequestType
reference: 62
```

In case of a success, it will respond with a `OK`.
```
0004 08351000203e
```
```javascript
type: StartSessionConfirmType
result: OK
reference: 62
```

Next, we see the following messages. I don't know what they mean.
```
0002 08200801100118012002
```
```javascript
type: CnNodeNotificationType
result: NOT_ALLOWED
reference: 2
1: 48
3: 255
```

```
0002 08200830100518ff012002
```
```javascript
type: SetAddressRequestType
result: BAD_REQUEST
reference: 2
3: 1
```

### CloseSession
The client logs out by sending a `CloseSessionRequestType`
```
0002 0804
```
```javascript
type: CloseSessionRequestType
```
