Zehnder ComfoConnect LAN C Protocol description
===============================================

**Warning: This documentation is very incomplete. If you have more information, don't hesitate to contribute by opening an issue or making a PR.**

# Discovery
The bridge can be discovered by sending a an UDP packet containing `0x0a00` to your network's broadcast address on port 56747.
It will respond with the following connection information. The last 6 bytes of the identifier seems to be the bridge's MAC address.
The IP Address is prefixed with `0x0a` and a 16-bit number indicating the length.

| Field       | Data                                         | Remark         |
|-------------|----------------------------------------------|----------------|
| Length      | `0x12` `0x..`                                | Total length of the whole packet |
| IP-Address  | `0x0a` `0x0c` `192.168.1.25`                 | Length + IP address of the bridge |
| Identifier  | `0x1210` `0x0000000000251010800170b3d54264b4` | Identifier of the bridge |
|             | `0x1801`                                     | _Unknown_      |

# Communication with the bridge
Further communication with the bridge happens by opening a TCP connection to the bridge on port 56747.
Every message will start with the `length` of the message, followed by a `src` and a `dst`. 
The `src` seems to be generated by the client, the `dst` has to be obtained from the discovery packet.
This header is attached before every message.

| Field       | Data                                         | Remark         |
|-------------|----------------------------------------------|----------------|
| Length      | `0x00000026`                                 | Total length of the whole packet |
| Source      | `0x0000000000251010800170b3d54264b4`         |                |
| Destination | `0xa886190220044d68a07d85a2e3866fce`         |                |

# Commands
A command block starts with a 32 bit number indicating the length of the command block, followed by the command code itself.

This is a list of the commands:

| Length   | Command  | Command description                                   |
|----------|----------|-------------------------------------------------------|
| `0x0004` | `0x0802` | Register (replies with `0x0834`)                      |
| `0x0004` | `0x0803` | Connect (replies with `0x0835`)                       |
| `0x0002` | `0x0804` | Disconnect                                            |
| `0x0004` | `0x0808` | _Unknown_ (replies with `0x083a`)                     |
| `0x0004` | `0x080a` | _Unknown_ (replies with `0x083c`)                     |
| `0x0004` | `0x0812` | _Unknown_ (replies with `0x0844`)                     |
| `0x0004` | `0x081e` | _Unknown_ (replies with `0x081f`)                     |
| `0x0004` | `0x0821` | _Unknown_ (replies with `0x0822`), seems to be a way to read data |
| `0x0004` | `0x0826` | _Unknown_ (replies with `0x0827`), might be a way to upload data |

This is a list of replies:

| Length   | Command  | Command description                                   |
|----------|----------|-------------------------------------------------------|
| `0x0004` | `0x081f` | _Unknown_ (answer to `0x081e`)                        |
| `0x0002` | `0x0820` | _Unknown_ message, received after login               |
| `0x0004` | `0x0822` | _Unknown_ (answer to `0x0821`)                        |
| `0x0006` | `0x0827` | _Unknown_ (answer to `0x0826`)                        |
| `0x0002` | `0x0828` | _Unknown_ message, seems to be a status update        |
| `0x0004` | `0x0834` | Register answer                                       |
| `0x0004` | `0x0835` | Connect answer                                        |
| `0x0004` | `0x083a` | _Unknown_ (answer to `0x0808`)                        |
| `0x0004` | `0x083c` | _Unknown_ (answer to `0x080a`)                        |
| `0x0004` | `0x0844` | _Unknown_ (answer to `0x0812`)                        |

## `0x0802` and `0x0834`: Registration
Before you can login, you need to register your device. If the PIN is 0000, the field should be `0x00`, otherwise, it should be written as a 16 bit number encoded according to the following algorithm.

* Convert the number to binary (`1111` -> `10001010111`)
* Insert a `1` before the 7th digit starting from the end (`10001010111` -> `1000*1*1010111`)
* Convert the number to a hexadecimal 16 bit number (`100011010111` -> `0x08D7`)
* Swap the bytes (`0x08D7` -> `0xD708`)

| Field       | Data                                         | Remark         |
|-------------|----------------------------------------------|----------------|
| Length      | `0x0004`                                     |                |
| Command     | `0x0802`                                     | Registration command |
| Sequence #  | `0x2002` (example)                           |                |
|             |                                              |                |
| Identifier  | `0x0a10` `0xa886190220044d68a07d85a2e3866fce` | The `src` identifier of the client |
| PIN         | `0x10` `0x00` or `0x10` `0x....`             | PIN code, see encoding above |
| Name        | `0x1a` `0x11` `Phone van Michael`            | Display name of your client |

In case of a failure (invalid PIN), the bridge will respond with the following message:

| Field       | Data                                         | Remark         |
|-------------|----------------------------------------------|----------------|
| Length      | `0x0006`                                     |                |
| Command     | `0x0834`                                     | Registration reply |
| Status Code | `0x1005`                                     | Invalid PIN    |
| Sequence #  | `0x2002` (example)                           |                |

In case of success, the bridge will then respond with the following message:

| Field       | Data                                         | Remark         |
|-------------|----------------------------------------------|----------------|
| Length      | `0x0004`                                     |                |
| Command     | `0x0834`                                     | Registration reply |
| Status Code | `0x1000`                                     | OK             |

## `0x0803` and `0x0835`: Connect

The client logs in by sending the following message:

| Field       | Data                                         | Remark         |
|-------------|----------------------------------------------|----------------|
| Length      | `0x0004`                                     |                |
| Command     | `0x0803`                                     | Connect command |
| Sequence #  | `0x2003` (example)                           |                |
|             |                                              |                |
|             | `0x0801` (optional)                          | _Unknown_, this seems to be added during the first login |

In case of success, the bridge will then respond with the following message:

| Field       | Data                                         | Remark         |
|-------------|----------------------------------------------|----------------|
| Length      | `0x0006`                                     |                |
| Command     | `0x0835`                                     | Connect command |
| Status Code | `0x1000`                                     | OK             |
| Sequence #  | `0x2003` (example)                           |                |

Next, we see some other messages. I don't know what they mean.

| Field       | Data                                         | Remark         |
|-------------|----------------------------------------------|----------------|
| Length      | `0x0002`                                     |                |
| Command     | `0x0820`                                     | _Unknown_      |
|             |                                              |                |
|             | `0x0801`                                     | _Unknown_      |
|             | `0x100118012002`                             | _Unknown_      |


| Field       | Data                                         | Remark         |
|-------------|----------------------------------------------|----------------|
| Length      | `0x0002`                                     |                |
| Command     | `0x0820`                                     | _Unknown_      |
|             |                                              |                |
|             | `0x0830`                                     | _Unknown_      |
|             | `0x100518ff012002`                           | _Unknown_      |

## `0x0804`: Disconnect

The client logs out by sending the following message:

| Field       | Data                                         | Remark         |
|-------------|----------------------------------------------|----------------|
| Length      | `0x0002`                                     |                |
| Command     | `0x0804`                                     | Disconnect command |


## `0x0828`: Status message (inbound)

During the session, the bridge will send status messages.

| Field       | Data                                         | Remark         |
|-------------|----------------------------------------------|----------------|
| Length      | `0x0002`                                     |                |
| Command     | `0x0828`                                     | Status message reply |
| Parameter   | `0x0878`                                     | Parameter      |
| Value       | `0x1202` `0x6d00`                            | Value          |

These are the parameters:

| Parameter   | Example value                                | Remark         |
|-------------|----------------------------------------------|----------------|
| `0x0810`    | `0x1201` `0x01`                              | _Unknown_      |
| `0x0821`    | `0x1201` `0x01`                              | _Unknown_      |
| `0x0825`    | `0x1201` `0x00`                              | _Unknown_      |
| `0x0831`    | `0x1201` `0x01`                              | _Unknown_      |
| `0x0835`    | `0x1201` `0xff`                              | _Unknown_      |
| `0x0838`    | `0x1201` `0x01`                              | _Unknown_      |
| `0x0841`    | `0x1201` `0x01`                              | _Unknown_      |
| `0x0842`    | `0x1201` `0x00`                              | _Unknown_      |
| `0x0843`    | `0x1201` `0x00`                              | _Unknown_      |
| `0x0846`    | `0x1201` `0x00`                              | _Unknown_      |
| `0x0847`    | `0x1201` `0x00`                              | _Unknown_      |
| `0x0851`    | `0x1204` `0xffffffff`                        | _Unknown_      |
| `0x0852`    | `0x1204` `0xffffffff`                        | _Unknown_      |
| `0x0855`    | `0x1204` `0xffffffff`                        | _Unknown_      |
| `0x0856`    | `0x1204` `0xffffffff`                        | _Unknown_      |
| `0x0857`    | `0x1204` `0xffffffff`                        | _Unknown_      |
| `0x0877`    | `0x1202` `0x6d00`                            | Fan speed      |
| `0x0878`    | `0x1202` `0x6d00`                            | Fan speed      |
| `0x0882`    | `03120100`                                   | _Unknown_      |
| `0x0892`    | `03120100`                                   | _Unknown_      |
| `0x0894`    | `0212027a00`                                 | _Unknown_      |
| `0x08a3`    | `03120100`                                   | _Unknown_      |
| `0x08b0`    | `01120100`                                   | _Unknown_      |
| `0x08c0`    | `011202a200`                                 | _Unknown_      |
| `0x08c1`    | `0212020300`                                 | _Unknown_      |
| `0x08c5`    | `0212020100`                                 | _Unknown_      |
| `0x08d0`    | `01120100`                                   | _Unknown_      |
| `0x08d1`    | `0112027800`                                 | _Unknown_      |
| `0x08d1`    | `02120426000000`                             | _Unknown_      |
| `0x08d2`    | `02120400000000`                             | _Unknown_      |
| `0x08d4`    | `011202e400`                                 | _Unknown_      |
| `0x08d5`    | `02120400000000`                             | _Unknown_      |
| `0x08dd`    | `011202a500`                                 | _Unknown_      |
| `0x08e0`    | `01120103`                                   | _Unknown_      |
| `0x08e1`    | `01120101`                                   | _Unknown_      |
| `0x08e2`    | `0112026400`                                 | _Unknown_      |
| `0x08f1`    | `02120100`                                   | _Unknown_      |
| `0x08f2`    | `02120100`                                   | _Unknown_      |
| `0x08f3`    | `02120100`                                   | _Unknown_      |
| `0x08f4`    | `02120100`                                   | _Unknown_      |
