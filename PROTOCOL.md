# ComfoControl Protocol
This document tries to explain the ComfoControl Protocol used by Zehnder ventilation units. You need a
*ComfoConnect LAN C* device to interface with the unit.

**Warning: This documentation is incomplete. If you have more information, don't hesitate to contribute by opening an
issue or making a PR.**

## General packet structure
The messages are send in a TCP-connection to port 56747, and are prepended with a header that resembles the
"Lenght-prefix protocol buffers" format.

This file [zehnder.proto](protobuf/zehnder.proto) contains a structured description of the protocol.

### Manually decoding a packet
The `protoc` utility can be used to manually decode a message based on the hex representation of the payload. You need
to strip the headers and extract the `op` and `msg` before passing it to `protoc`. See the sections below to find out
what to strip.

Example:
```markdown
0000004 ea886190220044d68a07d85a2e3866fce 0000000000251010800170b3d54264b4 0004 08022002 0a10a886190220044d68a07d85a2e3866fce10001a126950686f6e652076616e2044657374696e79
length_ src______________________________ dst_____________________________ opl_ op______ msg_____________________________________________________________________________
```

```sh
$ echo "08022002" | xxd -r -p | protoc --decode=GatewayOperation zehnder.proto
```
```javascript
type: RegisterAppRequestType
reference: 2
```

```sh
$ echo "0a10a886190220044d68a07d85a2e3866fce10001a126950686f6e652076616e2044657374696e79" | xxd -r -p | protoc --decode=RegisterAppRequest zehnder.proto
```
```javascript
uuid: "\250\206\031\002 \004Mh\240}\205\242\343\206o\316"
pin: 0
devicename: "iPhone van Destiny"
```

## Device discovery (`DiscoveryOperation`)
The bridge can be discovered by sending an UDP packet containing `0x0a00` to your network's broadcast address on port
56747. It will respond with the following connection information, also in a UDP packet. The last 6 bytes of the
identifier seems to be the bridge's MAC address. This packet contains no header and can be fully passed to Protocol
Buffers.

Raw response data:
```
12230a0d3139322e3136382e312e32313312100000000000251010800170b3d54264b41801
```
```javascript
searchGatewayResponse {
  ipaddress: "192.168.1.213"
  uuid: "\000\000\000\000\000%\020\020\200\001p\263\325Bd\264"
  version: 1
}
```

You now have the bridge's `ipaddress` and `uuid`. You need these for further communication.

## Bridge communication (`GatewayOperation`)
Further communication with the bridge happens by opening a TCP connection to the bridge on port 56747. Every message
will start with the `length` of the message, excluding this `length`-field itself. The header then consist of a `src`,
`dst` and `op_length`, followed by the `op` and the `msg`. The `src` seems to be generated by the client, the `dst` has
to be obtained from the discovery packet (`uuid`). The `op_length` fields indicates the length of the `op` field, the
rest of the data contains the `msg`.

Note that only `op` and `msg` is valid Protocol Buffers data. The other fields should not be parsed.

### Header
| Field                 | Data                                 | Remark                                                |
|-----------------------|--------------------------------------|-------------------------------------------------------|
| length (32 bit)       | `0x0000004f`                         | Length of the whole message excluding this field      |
| src (12 bytes)        | `0xaf154804169043898d2da77148f886be` |                                                       |
| dst (12 bytes)        | `0x0000000000251010800170b3d54264b4` |                                                       |
| oplength (16 bit)     | `0x0004`                             | Length of the `op` message                            | 
| op (variable length)  | `0x08342002`                         | Message with type `GatewayOperation`                  |
| msg (variable length) | `...`                                | Message with type that is documented in `op`          |

### Commands

This is a list of the commands.

| Request                       | Confirm                       | Notification / Response | Description                |
|-------------------------------|-------------------------------|-------------------------|----------------------------|
| NoOperation                   |                               |                         |                            |
| SetAddressRequestType         | SetAddressConfirmType         |                         |                            |
| RegisterAppRequestType        | RegisterAppConfirmType        |                         | Adds a device in the registration list |
| StartSessionRequestType       | StartSessionConfirmType       |                         | Start as session with the bridge |
| CloseSessionRequestType       | CloseSessionConfirmType       |                         | Terminate your session     |
| ListRegisteredAppsRequestType | ListRegisteredAppsConfirmType |                         | Returns a list of registered apps on the bridge |
| DeregisterAppRequestType      | DeregisterAppConfirmType      |                         | Remove a UUID from the registration list |
| ChangePinRequestType          | ChangePinConfirmType          |                         | Change the PIN code        |
| GetRemoteAccessIdRequestType  | GetRemoteAccessIdConfirmType  |                         |                            |
| SetRemoteAccessIdRequestType  | SetRemoteAccessIdConfirmType  |                         |                            |
| GetSupportIdRequestType       | GetSupportIdConfirmType       |                         |                            |
| GetWebIdRequestType           | GetWebIdConfirmType           |                         |                            |
| SetWebIdRequestType           | SetWebIdConfirmType           |                         |                            |
| SetPushIdRequestType          | SetPushIdConfirmType          |                         |                            |
| DebugRequestType              | DebugConfirmType              |                         |                            |
| UpgradeRequestType            | UpgradeConfirmType            |                         |                            |
| SetDeviceSettingsRequestType  | SetDeviceSettingsConfirmType  |                         |                            |
| VersionRequestType            | VersionConfirmType            |                         |                            |
|                               |                               | GatewayNotificationType |                            |
|                               |                               | KeepAliveType           |                            |
| FactoryResetType              |                               |                         |                            |
| CnTimeRequestType             | CnTimeConfirmType             |                         |                            |
| CnNodeRequestType             |                               | CnNodeNotificationType  |                            |
| CnRmiRequestType              | CnRmiResponseType             |                         |                            |
| CnRmiAsyncRequestType         | CnRmiAsyncConfirmType         | CnRmiAsyncResponseType  |                            |
| CnRpdoRequestType             | CnRpdoConfirmType             | CnRpdoNotificationType  |                            |
|                               |                               | CnAlarmNotificationType |                            |
| CnFupReadRegisterRequestType  | CnFupReadRegisterConfirmType  |                         |                            |
| CnFupProgramBeginRequestType  | CnFupProgramBeginConfirmType  |                         |                            |
| CnFupProgramRequestType       | CnFupProgramConfirmType       |                         |                            |
| CnFupProgramEndRequestType    | CnFupProgramEndConfirmType    |                         |                            |
| CnFupReadRequestType          | CnFupReadConfirmType          |                         |                            |
| CnFupResetRequestType         | CnFupResetConfirmType         |                         |                            |

### RegisterApp (`RegisterAppRequestType` and `RegisterAppConfirmType`)
Before you can login, you need to register your device, by sending `RegisterAppRequestType`.
```javascript
type: RegisterAppRequestType
reference: 15

uuid: "\251\226\031\002 \004Mh\240}\205\242\343\206o\312"
pin: 0
devicename: "Computer"
```

The bridge will respond with a `RegisterAppConfirmType`.

In case of success, it will respond like this:
```javascript
type: RegisterAppConfirmType
reference: 15
```

In case of a failure (invalid PIN), it will respond with a `RegisterAppConfirmType`, but with result `NOT_ALLOWED`.
```javascript
type: RegisterAppConfirmType
result: NOT_ALLOWED
reference: 15
```

## StartSession
The client logs in by sending a `StartSessionRequestType`.
```javascript
type: StartSessionRequestType
reference: 16
```

In case of a success, it will respond with a `OK`.
```javascript
type: StartSessionConfirmType
result: OK
reference: 16
```

Next, we see a few notifications. I guess they are messages to let the app know what type if device it is.
```javascript
type: CnNodeNotificationType

nodeId: 1
productId: 1
zoneId: 1
mode: NODE_NORMAL
```

```javascript
type: CnNodeNotificationType

nodeId: 48
productId: 5
zoneId: 255
mode: NODE_NORMAL
```

### CloseSession
The client logs out by sending a `CloseSessionRequestType`
```javascript
type: CloseSessionRequestType
```

## CnRpdoRequest
To receive status updates, you need to register to a `pdid` by sending a `CnRpdoRequestType`. You also need to specify a
`zone`, `type` and `timeout`. The zone always seems to be `1`. The `type` seems to depend on the `pdid`.

```javascript
type: CnRpdoRequestType
reference: 104

pdid: 176
zone: 1
type: 1
timeout: 4294967295
```

The bridge will reply with a `CnRpdoConfirmType`.

```javascript
type: CnRpdoConfirmType
result: OK
reference: 104
```

Next, when an update is available, the bridge will send a `CnRpdoNotificationType`.

```javascript
type: CnRpdoNotificationType

pdid: 176
data: "\000"
```

### Overview of known pdids
| pdid | type | description                                                                                            |
|------|------|--------------------------------------------------------------------------------------------------------|
| 16   | 1    | *Unknown* |
| 33   | 1    | *Unknown* |
| 37   | 1    | *Unknown* |
| 49   | 1    | *Unknown* |
| 53   | 1    | *Unknown* |
| 56   | 1    | *Unknown* |
| 65   | 1    | *Unknown* |
| 66   | 1    | *Unknown* |
| 67   | 1    | *Unknown* |
| 70   | 1    | *Unknown* |
| 71   | 1    | *Unknown* |
| 81   | 3    | *Unknown* |
| 82   | 3    | *Unknown* |
| 85   | 3    | *Unknown* |
| 86   | 3    | *Unknown* |
| 87   | 3    | *Unknown* |
| 117  | 1    | *Unknown* |
| 118  | 1    | *Unknown* |
| 119  | 2    | *Unknown* |
| 120  | 2    | *Unknown* |
| 121  | 2    | *Unknown* |
| 122  | 2    | *Unknown* |
| 128  | 2    | *Unknown* |
| 129  | 2    | *Unknown* |
| 130  | 2    | *Unknown* |
| 144  | 2    | *Unknown* |
| 145  | 2    | *Unknown* |
| 146  | 2    | *Unknown* |
| 176  | 1    | *Unknown* |
| 192  | 2    | *Unknown* |
| 208  | 1    | *Unknown* |
| 209  | 6    | *Unknown* |
| 210  | 0    | *Unknown* |
| 211  | 0    | *Unknown* |
| 212  | 6    | *Unknown* |
| 213  | 2    | *Unknown* |
| 214  | 2    | *Unknown* |
| 215  | 2    | *Unknown* |
| 216  | 2    | *Unknown* |
| 217  | 2    | *Unknown* |
| 218  | 2    | *Unknown* |
| 219  | 2    | *Unknown* |
| 221  | 6    | *Unknown* |
| 224  | 1    | *Unknown* |
| 225  | 1    | *Unknown* |
| 226  | 2    | *Unknown* |
| 227  | 1    | *Unknown* |
| 228  | 1    | *Unknown* |
| 274  | 6    | *Unknown* |
| 275  | 6    | *Unknown* |
| 276  | 6    | *Unknown* |
| 290  | 1    | *Unknown* |
| 291  | 1    | *Unknown* |
| 292  | 1    | *Unknown* |
| 294  | 1    | *Unknown* |
| 321  | 2    | *Unknown* |
| 325  | 2    | *Unknown* |
| 337  | 3    | *Unknown* |
| 338  | 3    | *Unknown* |
| 341  | 3    | *Unknown* |
| 369  | 1    | *Unknown* |
| 370  | 1    | *Unknown* |
| 371  | 1    | *Unknown* |
| 372  | 1    | *Unknown* |
| 384  | 6    | *Unknown* |
| 386  | 0    | *Unknown* |
| 400  | 6    | *Unknown* |
| 401  | 1    | *Unknown* |
| 402  | 0    | *Unknown* |
| 416  | 6    | *Unknown* |
| 417  | 6    | *Unknown* |
| 418  | 1    | *Unknown* |
| 419  | 0    | *Unknown* |
| 520  | 1    | *Unknown* |
| 784  | 1    | *Unknown* |
| 802  | 6    | *Unknown* |

## CnRmiRequest
You can execute a function on the device by invoking a `CnRmiRequest`. You need to specify the `nodeId` and a `message`.

```javascript
type: CnRmiRequestType
reference: 122

nodeId: 1
message: "\001\001\001\020\010"
```

The bridge will respond with a answer in a `CnRmiResponseType`.

```javascript
type: CnRmiResponseType
reference: 122

message: "ComfoAir Q450 B R RF ST Quality\000"
```

### Overview of known RMI requests
| Request                | Response                                                   | Description                    |
|------------------------|------------------------------------------------------------|--------------------------------|
| `02010101150304060507` | `\x02BEA004185031910\x00\x00\x10\x10\xc0\x02\x00T\x10@`    | *Unknown*                      |
| `80150101`             | `\x01\x00\x00\x00\x80Q\x01\x00\xff\xff\xff\xff\x01`        | *Unknown*                      |
| `83150101`             | `\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x01` | *Unknown*                      |
| `83150102`             | `\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x03` | *Unknown*                      |
| `83150105`             | `\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x01` | *Unknown*                      |
| `871501`               | `\x0b\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x01\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x03\x00\x00\x00\x00\x00 \x1c\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00 \x1c\x00\x00\x00\x00\x00\x00\x01\x01\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x01\x00\x00\x00\x00\x00X\x02\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00X\x02\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x08\x07\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x08\x07\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00X\x02\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\xb0\x04\x00\x00\x00\x00\x00\x00\x00` | *Unknown* |
| `871505`               | `\x01\x00\x00\x00\x00\x00\x08\x07\x00\x00\x00\x00\x00\x00\x01` | *Unknown*                  |
| `0117011002`           | `\x01`                                                     | *Unknown*                      |
| `0117021002`           | `\x00`                                                     | *Unknown*                      |
| `010101100b`           | `471502004\x00`                                            | *Unknown*                      |
| `012401100b`           | `\x00`                                                     | *Unknown*                      |
| `0125001003`           | `\x00`                                                     | *Unknown*                      |
| `0120011006`           | `\x00`                                                     | *Unknown*                      | 
| `861501`               | `\x01\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x02\x01\x00\x00\x00\x80Q\x01\x00\xff\xff\xff\xff\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00` | *Unknown* |
| `0120011006`           | `\x00`                                                     | *Unknown*                      |
| `0101011008`           | `ComfoAir Q450 B R RF ST Quality\x00`                      | Product name                   |

